{"version":3,"file":"error-collect.component.js","sourceRoot":"","sources":["../../../../../packages/abc/error-collect/error-collect.component.ts"],"names":[],"mappings":"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","sourcesContent":["import {\r\n  Component,\r\n  Directive,\r\n  OnInit,\r\n  Input,\r\n  HostBinding,\r\n  OnDestroy,\r\n  ElementRef,\r\n  Renderer2,\r\n  HostListener,\r\n  Inject,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n} from '@angular/core';\r\nimport { FormGroup } from '@angular/forms';\r\nimport { DOCUMENT } from '@angular/platform-browser';\r\nimport { coerceNumberProperty } from '@angular/cdk/coercion';\r\nimport { AdErrorCollectConfig } from './error-collect.config';\r\n\r\n/**\r\n * 错误消息采集器\r\n * PS：虽然此法并不好看，但对响应式表单&模板表单有很好的效果。\r\n */\r\n@Component({\r\n  selector: 'error-collect, [error-collect]',\r\n  template: `\r\n  <i class=\"anticon anticon-exclamation-circle\"></i>\r\n  <span class=\"pl-sm\">{{count}}</span>`,\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n  preserveWhitespaces: false,\r\n})\r\nexport class ErrorCollectComponent implements OnInit, OnDestroy {\r\n  private $time = null;\r\n  private formEl: HTMLFormElement;\r\n\r\n  @Input()\r\n  get freq() {\r\n    return this._freq;\r\n  }\r\n  set freq(value: any) {\r\n    this._freq = coerceNumberProperty(value);\r\n  }\r\n  private _freq = 500;\r\n\r\n  @Input()\r\n  get offsetTop() {\r\n    return this._offsetTop;\r\n  }\r\n  set offsetTop(value: any) {\r\n    this._offsetTop = coerceNumberProperty(value);\r\n  }\r\n  private _offsetTop = 65 + 64 + 8 * 2;\r\n\r\n  @HostBinding('class.d-none') _hiden = true;\r\n\r\n  count = 0;\r\n\r\n  constructor(\r\n    cog: AdErrorCollectConfig,\r\n    private el: ElementRef,\r\n    private renderer: Renderer2,\r\n    private cd: ChangeDetectorRef,\r\n    @Inject(DOCUMENT) private doc: any,\r\n  ) {\r\n    Object.assign(this, cog);\r\n  }\r\n\r\n  private get errEls() {\r\n    return this.formEl.querySelectorAll('.has-error');\r\n  }\r\n\r\n  private update() {\r\n    const count = this.errEls.length;\r\n    if (count === this.count) return;\r\n    this.count = count;\r\n    this._hiden = count === 0;\r\n    this.cd.markForCheck();\r\n  }\r\n\r\n  @HostListener('click')\r\n  _click() {\r\n    if (this.count === 0) return false;\r\n    // nz-form-control\r\n    const els = this.errEls;\r\n    const formItemEl = this.findParent(els[0], '[nz-form-control]') || els[0];\r\n    formItemEl.scrollIntoView(true);\r\n    // fix header height\r\n    this.doc.documentElement.scrollTop -= this.offsetTop;\r\n  }\r\n\r\n  private install() {\r\n    this.uninstall();\r\n    this.$time = setInterval(() => this.update(), this.freq);\r\n    this.update();\r\n  }\r\n\r\n  private uninstall() {\r\n    clearInterval(this.$time);\r\n  }\r\n\r\n  private findParent(el: any, selector: string) {\r\n    let retEl = null;\r\n    while (el) {\r\n      if (el.querySelector(selector)) {\r\n        retEl = el;\r\n        break;\r\n      }\r\n      el = el.parentElement;\r\n    }\r\n    return retEl;\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.formEl = this.findParent(this.el.nativeElement, 'form');\r\n    if (this.formEl === null) throw new Error('未找到有效 form 元素');\r\n    (this.el.nativeElement as HTMLElement).classList.add(\r\n      'error-collect',\r\n      'pr-lg',\r\n      'text-error',\r\n      'point',\r\n    );\r\n    this.install();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.uninstall();\r\n  }\r\n}\r\n"]}