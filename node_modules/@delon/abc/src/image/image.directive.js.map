{"version":3,"file":"image.directive.js","sourceRoot":"","sources":["../../../../../packages/abc/image/image.directive.ts"],"names":[],"mappings":";;;;AAAA,OAAO,EACL,SAAS,EACT,KAAK,EAEL,UAAU,EACV,SAAS,GAIV,MAAM,eAAe,CAAC;AACvB,OAAO,EAAE,QAAQ,EAAE,MAAM,aAAa,CAAC;AACvC,OAAO,EAAE,aAAa,EAAE,MAAM,gBAAgB,CAAC;;;;;;;;IAkB7C,wBACU,IACA,QACR,GAAkB;QAFV,OAAE,GAAF,EAAE;QACF,WAAM,GAAN,MAAM;oBARA,EAAE;qBAED,uBAAuB;sBAEvB,KAAK;QAOpB,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC;KACpC;;;;IAED,iCAAQ;;;IAAR;QACE,IAAI,CAAC,MAAM,EAAE,CAAC;QACd,IAAI,CAAC,WAAW,EAAE,CAAC;QACnB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;KACpB;;;;;IAED,oCAAW;;;;IAAX,UACE,OAA6D;QAE7D,EAAE,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;YAChB,EAAE,CAAC,CAAC,OAAO,CAAC,KAAK,CAAC;gBAAC,IAAI,CAAC,WAAW,EAAE,CAAC;YACtC,IAAI;gBAAC,IAAI,CAAC,MAAM,EAAE,CAAC;SACpB;KACF;;;;IAEO,+BAAM;;;;QACZ,qBAAI,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC;;QAGtB,EAAE,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;YAChC,qBAAM,GAAG,GAAG,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC;YAC3B,IAAI,GAAG,GAAG,CAAC,GAAG,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;YAC7B,GAAG,CAAC,GAAG,CAAC,MAAM,GAAG,CAAC,CAAC;gBACjB,IAAI,KAAK,GAAG,IAAI,CAAC,IAAI,KAAK,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;YACpE,MAAM,GAAG,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;SACxB;;;QAID,qBAAM,MAAM,GAAG,MAAM,CAAC,UAAU,CAAC,OAAO,CAAC;QACvC,OAAO,GAAG,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;QACxC,EAAE,CAAC,CAAC,MAAM,IAAI,OAAO,CAAC;YAAC,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;;QAI9D,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,CAAC,aAAa,EAAE,KAAK,EAAE,MAAM,CAAC,CAAC;;;;;IAGzD,oCAAW;;;;QACjB,IAAI,CAAC,MAAM,CAAC,YAAY,CACtB,IAAI,CAAC,EAAE,CAAC,aAAa,EACrB,SAAS,EACT,eAAa,IAAI,CAAC,KAAK,OAAI,CAC5B,CAAC;;;gBA7DL,SAAS,SAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE;;;;gBAf/B,UAAU;gBACV,SAAS;gBAMF,aAAa;;;wBAUnB,KAAK,SAAC,MAAM;yBAEZ,KAAK;0BAEL,KAAK;;yBAzBR;;SAoBa,cAAc","sourcesContent":["import {\r\n  Directive,\r\n  Input,\r\n  OnChanges,\r\n  ElementRef,\r\n  Renderer2,\r\n  SimpleChanges,\r\n  OnInit,\r\n  SimpleChange,\r\n} from '@angular/core';\r\nimport { deepCopy } from '@delon/util';\r\nimport { AdImageConfig } from './image.config';\r\n\r\n/**\r\n * img标签\r\n * + 支持微信、qq头像规则缩略图规则\r\n * + 支持移除http&https协议http\r\n * + 支持增加onerror事件\r\n */\r\n@Directive({ selector: '[_src]' })\r\nexport class ImageDirective implements OnChanges, OnInit {\r\n  @Input('_src') src: string;\r\n\r\n  @Input() size = 64;\r\n\r\n  @Input() error = './assets/img/logo.svg';\r\n\r\n  private inited = false;\r\n\r\n  constructor(\r\n    private el: ElementRef,\r\n    private render: Renderer2,\r\n    DEF: AdImageConfig,\r\n  ) {\r\n    Object.assign(this, deepCopy(DEF));\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    this.update();\r\n    this.updateError();\r\n    this.inited = true;\r\n  }\r\n\r\n  ngOnChanges(\r\n    changes: { [P in keyof this]?: SimpleChange } & SimpleChanges,\r\n  ): void {\r\n    if (this.inited) {\r\n      if (changes.error) this.updateError();\r\n      else this.update();\r\n    }\r\n  }\r\n\r\n  private update() {\r\n    let newSrc = this.src;\r\n\r\n    // region: fix weixin & qq avatar size\r\n    if (newSrc.includes('qlogo.cn')) {\r\n      const arr = newSrc.split('/'),\r\n        size = arr[arr.length - 1];\r\n      arr[arr.length - 1] =\r\n        size === '0' || +size !== this.size ? this.size.toString() : size;\r\n      newSrc = arr.join('/');\r\n    }\r\n    // endregion\r\n\r\n    // region: remove https & http\r\n    const isHttp = newSrc.startsWith('http:'),\r\n      isHttps = newSrc.startsWith('https:');\r\n    if (isHttp || isHttps) newSrc = newSrc.substr(isHttp ? 5 : 6);\r\n\r\n    // endregion\r\n\r\n    this.render.setAttribute(this.el.nativeElement, 'src', newSrc);\r\n  }\r\n\r\n  private updateError() {\r\n    this.render.setAttribute(\r\n      this.el.nativeElement,\r\n      'onerror',\r\n      `this.src='${this.error}';`,\r\n    );\r\n  }\r\n}\r\n"]}