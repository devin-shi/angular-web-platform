{"version":3,"file":"down-file.directive.js","sourceRoot":"","sources":["../../../../../packages/abc/down-file/down-file.directive.ts"],"names":[],"mappings":";;;;AAAA,OAAO,EACL,SAAS,EACT,UAAU,EACV,KAAK,EACL,YAAY,EACZ,YAAY,EACZ,MAAM,GACP,MAAM,eAAe,CAAC;AACvB,OAAO,EAAgB,UAAU,EAAE,MAAM,sBAAsB,CAAC;AAChE,OAAO,EAAE,MAAM,EAAE,MAAM,YAAY,CAAC;;;;;;;;;IAwBlC,2BAAoB,EAAc,EAAU,IAAgB;QAAxC,OAAE,GAAF,EAAE,CAAY;QAAU,SAAI,GAAJ,IAAI,CAAY;;;;0BAVjB,KAAK;;;;uBAMT,IAAI,YAAY,EAAO;;;;qBAEzB,IAAI,YAAY,EAAO;KAEI;;;;IAGhE,kCAAM;;;;;QACJ,IAAI,CAAC,EAAE,CAAC,aAAa,CAAC,QAAQ,GAAG,IAAI,CAAC;QACtC,IAAI,CAAC,IAAI;aACN,OAAO,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,OAAO,EAAE;YACtC,MAAM,EAAE,IAAI,CAAC,QAAQ,IAAI,EAAE;YAC3B,YAAY,EAAE,MAAM;YACpB,OAAO,EAAE,UAAU;SACpB,CAAC;aACD,SAAS,CACR,UAAC,GAAuB;YACtB,EAAE,CAAC,CAAC,GAAG,CAAC,MAAM,KAAK,GAAG,IAAI,GAAG,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,CAAC,CAAC,CAAC;gBAC7C,KAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBACrB,MAAM,CAAC;aACR;YACD,qBAAM,QAAQ,GACZ,KAAI,CAAC,QAAQ;gBACb,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC;gBAC3B,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;YAChC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,SAAS,CAAC,QAAQ,CAAC,CAAC,CAAC;YACtC,KAAI,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YACvB,KAAI,CAAC,EAAE,CAAC,aAAa,CAAC,QAAQ,GAAG,KAAK,CAAC;SACxC,EACD,UAAA,GAAG;YACD,KAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YACrB,KAAI,CAAC,EAAE,CAAC,aAAa,CAAC,QAAQ,GAAG,KAAK,CAAC;SACxC,CACF,CAAC;;;gBA5CP,SAAS,SAAC,EAAE,QAAQ,EAAE,aAAa,EAAE;;;;gBAhBpC,UAAU;gBAMW,UAAU;;;6BAa9B,KAAK,SAAC,WAAW;+BAEjB,KAAK,SAAC,aAAa;4BAEnB,KAAK,SAAC,UAAU;6BAEhB,KAAK,SAAC,WAAW;4BAEjB,MAAM;0BAEN,MAAM;2BAIN,YAAY,SAAC,OAAO;;4BAnCvB;;SAmBa,iBAAiB","sourcesContent":["import {\r\n  Directive,\r\n  ElementRef,\r\n  Input,\r\n  HostListener,\r\n  EventEmitter,\r\n  Output,\r\n} from '@angular/core';\r\nimport { HttpResponse, HttpClient } from '@angular/common/http';\r\nimport { saveAs } from 'file-saver';\r\n\r\n/**\r\n * 文件下载\r\n *\r\n * ```html\r\n * <button nz-button down-file http-url=\"assets/demo{{i}}\" file-name=\"demo中文\">{{i}}</button>\r\n * ```\r\n */\r\n@Directive({ selector: '[down-file]' })\r\nexport class DownFileDirective {\r\n  /** URL请求参数 */\r\n  @Input('http-data') httpData: any;\r\n  /** 请求类型 */\r\n  @Input('http-method') httpMethod: string = 'get';\r\n  /** 下载地址 */\r\n  @Input('http-url') httpUrl: string;\r\n  /** 指定文件名，若为空从服务端返回的 `header` 中获取 `filename`、`x-filename` */\r\n  @Input('file-name') fileName: string;\r\n  /** 成功回调 */\r\n  @Output() success: EventEmitter<any> = new EventEmitter<any>();\r\n  /** 错误回调 */\r\n  @Output() error: EventEmitter<any> = new EventEmitter<any>();\r\n\r\n  constructor(private el: ElementRef, private http: HttpClient) {}\r\n\r\n  @HostListener('click')\r\n  _click() {\r\n    this.el.nativeElement.disabled = true;\r\n    this.http\r\n      .request(this.httpMethod, this.httpUrl, {\r\n        params: this.httpData || {},\r\n        responseType: 'blob',\r\n        observe: 'response',\r\n      })\r\n      .subscribe(\r\n        (res: HttpResponse<Blob>) => {\r\n          if (res.status !== 200 || res.body.size <= 0) {\r\n            this.error.emit(res);\r\n            return;\r\n          }\r\n          const fileName =\r\n            this.fileName ||\r\n            res.headers.get('filename') ||\r\n            res.headers.get('x-filename');\r\n          saveAs(res.body, decodeURI(fileName));\r\n          this.success.emit(res);\r\n          this.el.nativeElement.disabled = false;\r\n        },\r\n        err => {\r\n          this.error.emit(err);\r\n          this.el.nativeElement.disabled = false;\r\n        },\r\n      );\r\n  }\r\n}\r\n"]}