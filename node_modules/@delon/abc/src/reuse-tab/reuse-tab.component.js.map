{"version":3,"file":"reuse-tab.component.js","sourceRoot":"","sources":["../../../../../packages/abc/reuse-tab/reuse-tab.component.ts"],"names":[],"mappings":"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","sourcesContent":["import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  OnChanges,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  EventEmitter,\r\n  OnInit,\r\n  SimpleChanges,\r\n  SimpleChange,\r\n  OnDestroy,\r\n  ElementRef,\r\n  Renderer2,\r\n  Inject,\r\n  Optional,\r\n} from '@angular/core';\r\nimport { Router, NavigationEnd, ActivatedRoute } from '@angular/router';\r\nimport { DOCUMENT } from '@angular/platform-browser';\r\nimport { Subscription } from 'rxjs/Subscription';\r\nimport { combineLatest } from 'rxjs/observable/combineLatest';\r\nimport { filter } from 'rxjs/operators';\r\nimport {\r\n  coerceNumberProperty,\r\n  coerceBooleanProperty,\r\n} from '@angular/cdk/coercion';\r\n\r\nimport { ALAIN_I18N_TOKEN, AlainI18NService } from '@delon/theme';\r\n\r\nimport { ReuseTabService } from './reuse-tab.service';\r\nimport {\r\n  ReuseTabCached,\r\n  ReuseTabNotify,\r\n  ReuseTabMatchMode,\r\n  ReuseItem,\r\n  ReuseContextI18n,\r\n  ReuseContextCloseEvent,\r\n  ReuseTitle,\r\n} from './interface';\r\nimport { ReuseTabContextService } from './reuse-tab-context.service';\r\n\r\n@Component({\r\n  selector: 'reuse-tab',\r\n  template: `<nz-tabset [nzSelectedIndex]=\"pos\" [nzAnimated]=\"false\" nzType=\"line\"> <nz-tab *ngFor=\"let i of list; let index = index\" [nzTitle]=\"titleTemplate\"> <ng-template #titleTemplate> <span [context-menu]=\"i\" (click)=\"to($event, index)\" class=\"name\">{{i.title}}</span> <i *ngIf=\"i.closable\" class=\"anticon anticon-close op\" (click)=\"_close($event, index, false)\"></i> </ng-template> </nz-tab> </nz-tabset> <reuse-tab-context [i18n]=\"i18n\" (change)=\"cmChange($event)\"></reuse-tab-context> `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n  preserveWhitespaces: false,\r\n  providers: [ReuseTabContextService],\r\n})\r\nexport class ReuseTabComponent implements OnInit, OnChanges, OnDestroy {\r\n  private sub$: Subscription;\r\n  private i18n$: Subscription;\r\n  list: ReuseItem[] = [];\r\n  item: ReuseItem;\r\n  pos = 0;\r\n\r\n  // region: properties\r\n  /** 设置匹配模式 */\r\n  @Input() mode: ReuseTabMatchMode = ReuseTabMatchMode.Menu;\r\n  /** 选项文本国际化 */\r\n  @Input() i18n: ReuseContextI18n;\r\n  /** 是否Debug模式 */\r\n  @Input()\r\n  get debug() {\r\n    return this._debug;\r\n  }\r\n  set debug(value: any) {\r\n    this._debug = coerceBooleanProperty(value);\r\n  }\r\n  private _debug = false;\r\n  /** 允许最多复用多少个页面 */\r\n  @Input()\r\n  get max() {\r\n    return this._max;\r\n  }\r\n  set max(value: any) {\r\n    this._max = coerceNumberProperty(value);\r\n  }\r\n  private _max: number;\r\n  /** 排除规则，限 `mode=URL` */\r\n  @Input() excludes: RegExp[];\r\n  /** 允许关闭 */\r\n  @Input()\r\n  get allowClose() {\r\n    return this._allowClose;\r\n  }\r\n  set allowClose(value: any) {\r\n    this._allowClose = coerceBooleanProperty(value);\r\n  }\r\n  private _allowClose = true;\r\n  /** 是否固定 */\r\n  @Input()\r\n  get fixed() {\r\n    return this._fixed;\r\n  }\r\n  set fixed(value: any) {\r\n    this._fixed = coerceBooleanProperty(value);\r\n  }\r\n  private _fixed = true;\r\n  /** 总是显示当前页 */\r\n  @Input()\r\n  get showCurrent() {\r\n    return this._showCurrent;\r\n  }\r\n  set showCurrent(value: any) {\r\n    this._showCurrent = coerceBooleanProperty(value);\r\n  }\r\n  private _showCurrent = true;\r\n  /** 切换时回调 */\r\n  @Output() change: EventEmitter<ReuseItem> = new EventEmitter<ReuseItem>();\r\n  /** 关闭回调 */\r\n  @Output() close: EventEmitter<ReuseItem> = new EventEmitter<ReuseItem>();\r\n  // endregion\r\n\r\n  constructor(\r\n    public srv: ReuseTabService,\r\n    private cd: ChangeDetectorRef,\r\n    private router: Router,\r\n    private route: ActivatedRoute,\r\n    private el: ElementRef,\r\n    private render: Renderer2,\r\n    @Inject(DOCUMENT) private doc: any,\r\n    @Optional()\r\n    @Inject(ALAIN_I18N_TOKEN)\r\n    private i18nSrv: AlainI18NService,\r\n  ) {\r\n    const route$ = this.router.events.pipe(\r\n      filter(evt => evt instanceof NavigationEnd),\r\n    );\r\n    this.sub$ = <any>combineLatest(this.srv.change, route$).subscribe(\r\n      ([res, e]) => this.genList(res),\r\n    );\r\n    if (this.i18nSrv)\r\n      this.i18n$ = this.i18nSrv.change.subscribe(() => this.genList());\r\n  }\r\n\r\n  private genTit(title: ReuseTitle): string {\r\n    return title.i18n && this.i18nSrv\r\n      ? this.i18nSrv.fanyi(title.i18n)\r\n      : title.text;\r\n  }\r\n\r\n  private genList(notify?: ReuseTabNotify) {\r\n    const isClosed = notify && notify.active === 'close';\r\n    const beforeClosePos = isClosed\r\n      ? this.list.findIndex(w => w.url === notify.url)\r\n      : -1;\r\n    const ls = this.srv.items.map((item: ReuseTabCached, index: number) => {\r\n      return <ReuseItem>{\r\n        url: item.url,\r\n        title: this.genTit(item.title),\r\n        closable: this.allowClose && item.closable && this.srv.count > 0,\r\n        index,\r\n        active: false,\r\n        last: false,\r\n      };\r\n    });\r\n    if (this.showCurrent) {\r\n      const snapshot = this.route.snapshot;\r\n      const url = this.srv.getUrl(snapshot);\r\n      const idx = ls.findIndex(w => w.url === url);\r\n      // jump directly when the current exists in the list\r\n      // or create a new current item and jump\r\n      if (idx !== -1 || (isClosed && notify.url === url)) {\r\n        this.pos = isClosed\r\n          ? idx >= beforeClosePos\r\n            ? this.pos - 1\r\n            : this.pos\r\n          : idx;\r\n      } else {\r\n        const snapshotTrue = this.srv.getTruthRoute(snapshot);\r\n        ls.push(<ReuseItem>{\r\n          url,\r\n          title: this.genTit(this.srv.getTitle(url, snapshotTrue)),\r\n          closable:\r\n            this.allowClose &&\r\n            this.srv.count > 0 &&\r\n            this.srv.getClosable(url, snapshotTrue),\r\n          index: ls.length,\r\n          active: false,\r\n          last: false,\r\n        });\r\n        this.pos = ls.length - 1;\r\n      }\r\n      // fix unabled close last item\r\n      if (ls.length <= 1) ls[0].closable = false;\r\n    }\r\n\r\n    this.list = ls;\r\n\r\n    if (ls.length && isClosed) {\r\n      this.to(null, this.pos);\r\n    }\r\n\r\n    this.refStatus(false);\r\n    this.visibility();\r\n    this.cd.detectChanges();\r\n  }\r\n\r\n  private visibility() {\r\n    if (this.showCurrent) return;\r\n    this.render.setStyle(\r\n      this.el.nativeElement,\r\n      'display',\r\n      this.list.length === 0 ? 'none' : 'block',\r\n    );\r\n  }\r\n\r\n  // region: UI\r\n\r\n  cmChange(res: ReuseContextCloseEvent) {\r\n    switch (res.type) {\r\n      case 'close':\r\n        this._close(null, res.item.index, res.includeNonCloseable);\r\n        break;\r\n      case 'closeRight':\r\n        this.srv.closeRight(res.item.url, res.includeNonCloseable);\r\n        this.close.emit(null);\r\n        break;\r\n      case 'clear':\r\n      case 'closeOther':\r\n        this.srv.clear(res.includeNonCloseable);\r\n        this.close.emit(null);\r\n        break;\r\n    }\r\n  }\r\n\r\n  refStatus(dc = true) {\r\n    if (this.list.length) {\r\n      this.list[this.list.length - 1].last = true;\r\n      this.list.forEach((i, idx) => (i.active = this.pos === idx));\r\n    }\r\n    if (dc) this.cd.detectChanges();\r\n  }\r\n\r\n  to(e: Event, index: number) {\r\n    if (e) {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n    }\r\n    index = Math.max(0, Math.min(index, this.list.length - 1));\r\n    const item = this.list[index];\r\n    this.router.navigateByUrl(item.url).then(res => {\r\n      if (!res) return;\r\n      this.pos = index;\r\n      this.item = item;\r\n      this.refStatus();\r\n      this.change.emit(item);\r\n    });\r\n  }\r\n\r\n  _close(e: Event, idx: number, includeNonCloseable: boolean) {\r\n    if (e) {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n    }\r\n    const item = this.list[idx];\r\n    this.srv.close(item.url, includeNonCloseable);\r\n    this.close.emit(item);\r\n    this.cd.detectChanges();\r\n    return false;\r\n  }\r\n\r\n  // endregion\r\n\r\n  ngOnInit(): void {\r\n    this.setClass();\r\n\r\n    this.genList();\r\n  }\r\n\r\n  private setClass() {\r\n    const el = this.el.nativeElement;\r\n    const body = this.doc.querySelector('body');\r\n    const fixedCls = `fixed`;\r\n    const bodyCls = `has-reuse-tab`;\r\n    if (this.fixed) {\r\n      this.render.addClass(el, fixedCls);\r\n      this.render.addClass(body, bodyCls);\r\n    } else {\r\n      this.render.removeClass(el, fixedCls);\r\n      this.render.removeClass(body, bodyCls);\r\n    }\r\n  }\r\n\r\n  ngOnChanges(\r\n    changes: { [P in keyof this]?: SimpleChange } & SimpleChanges,\r\n  ): void {\r\n    if (changes.max) this.srv.max = this.max;\r\n    if (changes.excludes) this.srv.excludes = this.excludes;\r\n    if (changes.mode) this.srv.mode = this.mode;\r\n    this.srv.debug = this.debug;\r\n\r\n    this.setClass();\r\n    this.cd.detectChanges();\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.sub$.unsubscribe();\r\n    if (this.i18n$) this.i18n$.unsubscribe();\r\n  }\r\n}\r\n"]}