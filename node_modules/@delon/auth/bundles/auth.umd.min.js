/**
 * @license ng-alain(cipchk@qq.com) v1.0.0-beta.10
 * (c) 2018 Cipchk http://ng-alain.com/
 * License: MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs/Observable"),require("@angular/core"),require("@angular/router"),require("@angular/platform-browser"),require("@angular/common/http"),require("@delon/theme"),require("rxjs/BehaviorSubject"),require("rxjs/operators")):"function"==typeof define&&define.amd?define(["exports","rxjs/Observable","@angular/core","@angular/router","@angular/platform-browser","@angular/common/http","@delon/theme","rxjs/BehaviorSubject","rxjs/operators"],t):t((e.delon=e.delon||{},e.delon.auth={}),e.Rx,e.ng.core,e.ng.router,e.ng.platformBrowser,e.ng.common.http,e.delon.theme,e.Rx,e.Rx.Observable.prototype)}(this,function(e,a,o,c,t,u,l,r,n){"use strict";var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])};function s(e,t){function o(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}var p=new o.InjectionToken("DELON_AUTH_TOKEN_SERVICE_TOKEN"),h="_delonAuthSocialType",f="_delonAuthSocialCallbackByHref",d=function(){function e(e,t,o){this.tokenService=e,this.doc=t,this.router=o}return e.prototype.login=function(e,t,o){var r=this;if(void 0===t&&(t="/"),void 0===o&&(o={}),o=Object.assign({type:"window",windowFeatures:"location=yes,height=570,width=520,scrollbars=yes,status=yes"},o),localStorage.setItem(h,o.type),localStorage.setItem(f,t),"href"!==o.type)return this._win=window.open(e,"_blank",o.windowFeatures),this._win$=setInterval(function(){if(r._win&&r._win.closed){r.ngOnDestroy();var e=r.tokenService.get();e&&!e.token&&(e=null),e&&r.tokenService.set(e),r.observer.next(e),r.observer.complete()}},100),a.Observable.create(function(e){r.observer=e});this.doc.location.href=e},e.prototype.callback=function(e){if(!e&&-1===this.router.url.indexOf("?"))throw new Error("url muse contain a ?");var t={token:""};if("string"==typeof e){var o=e.split("?")[1].split("#")[0];t=this.router.parseUrl("./?"+o).queryParams}else t=e;if(!t||!t.token)throw new Error("invalide token data");this.tokenService.set(t);var r=localStorage.getItem(f)||"/";localStorage.removeItem(f);var n=localStorage.getItem(h);return localStorage.removeItem(h),"window"===n?window.close():this.router.navigateByUrl(r),t},e.prototype.ngOnDestroy=function(){clearInterval(this._win$),this._win$=null},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:o.Inject,args:[p]}]},{type:void 0,decorators:[{type:o.Inject,args:[t.DOCUMENT]}]},{type:c.Router}]},e}(),g=new o.InjectionToken("AUTH_STORE_TOKEN"),y=function(){function e(){}return e.prototype.get=function(e){return JSON.parse(localStorage.getItem(e)||"{}")||{}},e.prototype.set=function(e,t){return localStorage.setItem(e,JSON.stringify(t)),!0},e.prototype.remove=function(e){localStorage.removeItem(e)},e}(),_=function(){function e(){this.cache={}}return e.prototype.get=function(e){return this.cache[e]||{}},e.prototype.set=function(e,t){return this.cache[e]=t,!0},e.prototype.remove=function(e){this.cache[e]=null},e}(),m=function(){function e(){}return e.prototype.get=function(e){return JSON.parse(sessionStorage.getItem(e)||"{}")||{}},e.prototype.set=function(e,t){return sessionStorage.setItem(e,JSON.stringify(t)),!0},e.prototype.remove=function(e){sessionStorage.removeItem(e)},e}(),v=function(){function e(){this.store_key="_token",this.token_invalid_redirect=!0,this.token_exp_offset=10,this.token_send_key="token",this.token_send_template="${token}",this.token_send_place="header",this.login_url="/login",this.ignores=[/\/login/,/assets\//,/passport\//],this.allow_anonymous_key="_allow_anonymous"}return e.decorators=[{type:o.Injectable}],e}(),b=new o.InjectionToken("Window"),k=function(){function e(e){this.injector=e}return e.prototype.intercept=function(e,t){var o=this,r=Object.assign(new v,this.injector.get(v,null));if(r.ignores)for(var n=0,i=r.ignores;n<i.length;n++){if(i[n].test(e.url))return t.handle(e)}if(r.allow_anonymous_key&&e.params.has(r.allow_anonymous_key))return t.handle(e);if(!this.isAuth(r)){!0===r.token_invalid_redirect&&setTimeout(function(){/^https?:\/\//g.test(r.login_url)?o.injector.get(b).location.href=r.login_url:o.injector.get(c.Router).navigate([r.login_url])});var s=this.injector.get(l._HttpClient,null);return s&&s.end(),new a.Observable(function(e){var t=new u.HttpErrorResponse({status:401,statusText:"From Simple Intercept --\x3e http://ng-alain.com/docs/auth"});e.error(t)})}return e=this.setReq(e,r),t.handle(e)},e.ctorParameters=function(){return[{type:o.Injector,decorators:[{type:o.Optional}]}]},e}(),w=function(){function e(e,t){this.options=e,this.store=t,this.change$=new r.BehaviorSubject(null)}return Object.defineProperty(e.prototype,"login_url",{get:function(){return this.options.login_url},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"redirect",{get:function(){return this._redirect||"/"},set:function(e){this._redirect=e},enumerable:!0,configurable:!0}),e.prototype.set=function(e){return this.change$.next(e),this.store.set(this.options.store_key,e)},e.prototype.get=function(e){var t=this.store.get(this.options.store_key);return e?Object.assign(new e,t):t},e.prototype.clear=function(){this.change$.next(null),this.store.remove(this.options.store_key)},e.prototype.change=function(){return this.change$.pipe(n.share())},e.decorators=[{type:o.Injectable}],e.ctorParameters=function(){return[{type:v},{type:void 0,decorators:[{type:o.Inject,args:[g]}]}]},e}();function S(e){var t,o=e.replace(/-/g,"+").replace(/_/g,"/");switch(o.length%4){case 0:break;case 2:o+="==";break;case 3:o+="=";break;default:throw new Error("'atob' failed: The string to be decoded is not correctly encoded.")}return t=o,decodeURIComponent(Array.prototype.map.call(function(e){var t="";e=String(e).replace(/=+$/,"");for(var o=0,r=void 0,n=void 0,i=0;n=e.charAt(i++);~n&&(r=o%4?64*r+n:n,o++%4)?t+=String.fromCharCode(255&r>>(-2*o&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return t}(t),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}var j=function(){function e(){}return Object.defineProperty(e.prototype,"payload",{get:function(){var e=this.token.split(".");if(3!==e.length)throw new Error("JWT must have 3 parts");var t=S(e[1]);return JSON.parse(t)},enumerable:!0,configurable:!0}),e.prototype.isExpired=function(e){void 0===e&&(e=0);var t=this.payload;if(!t.hasOwnProperty("exp"))return null;var o=new Date(0);return o.setUTCSeconds(t.exp),!(o.valueOf()>(new Date).valueOf()+1e3*e)},e}(),O=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return s(t,e),t.prototype.isAuth=function(e){return this.model=this.injector.get(p).get(j),this.model&&this.model.token&&!this.model.isExpired(e.token_exp_offset)},t.prototype.setReq=function(e,t){return e.clone({setHeaders:{Authorization:"Bearer "+this.model.token}})},t.decorators=[{type:o.Injectable}],t}(k),I=function(){},x=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return s(t,e),t.prototype.isAuth=function(e){return this.model=this.injector.get(p).get(),this.model&&"string"==typeof this.model.token&&0<this.model.token.length},t.prototype.setReq=function(e,t){var o=this,r=t.token_send_template.replace(/\$\{([\w]+)\}/g,function(e,t){return o.model[t]});switch(t.token_send_place){case"header":var n={};n[t.token_send_key]=r,e=e.clone({setHeaders:n});break;case"body":var i=e.body||{};i[t.token_send_key]=r,e=e.clone({body:i});break;case"url":e=e.clone({params:e.params.append(t.token_send_key,r)})}return e},t.decorators=[{type:o.Injectable}],t}(k),T=function(){function e(){}return e.forRoot=function(){return{ngModule:e,providers:[{provide:b,useValue:window},v,{provide:g,useClass:y},{provide:p,useClass:w}]}},e.decorators=[{type:o.NgModule,args:[{}]}],e}();e.SocialService=d,e.DA_STORE_TOKEN=g,e.LocalStorageStore=y,e.MemoryStore=_,e.SessionStorageStore=m,e.BaseInterceptor=k,e.DA_SERVICE_TOKEN=p,e.TokenService=w,e.urlBase64Decode=S,e.JWTTokenModel=j,e.JWTInterceptor=O,e.SimpleTokenModel=I,e.SimpleInterceptor=x,e.DelonAuthConfig=v,e.DelonAuthModule=T,e.Éµa=b,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=auth.umd.min.js.map
