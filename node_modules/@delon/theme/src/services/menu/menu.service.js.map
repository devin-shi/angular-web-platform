{"version":3,"file":"menu.service.js","sourceRoot":"","sources":["../../../../../../packages/theme/services/menu/menu.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, Inject, Optional, OnDestroy } from '@angular/core';\r\nimport { Observable } from 'rxjs/Observable';\r\nimport { BehaviorSubject } from 'rxjs/BehaviorSubject';\r\nimport { share } from 'rxjs/operators';\r\nimport { Subscription } from 'rxjs/Subscription';\r\n\r\nimport { ACLService } from '@delon/acl';\r\n\r\nimport { ALAIN_I18N_TOKEN, AlainI18NService } from '../i18n/i18n';\r\nimport { Menu } from './interface';\r\n\r\n@Injectable()\r\nexport class MenuService implements OnDestroy {\r\n  private _change$: BehaviorSubject<Menu[]> = new BehaviorSubject<Menu[]>([]);\r\n  private i18n$: Subscription;\r\n\r\n  private data: Menu[] = [];\r\n\r\n  constructor(\r\n    @Optional()\r\n    @Inject(ALAIN_I18N_TOKEN)\r\n    private i18nSrv: AlainI18NService,\r\n    @Optional() private aclService: ACLService,\r\n  ) {\r\n    if (this.i18nSrv)\r\n      this.i18n$ = this.i18nSrv.change.subscribe(() => this.resume());\r\n  }\r\n\r\n  get change(): Observable<Menu[]> {\r\n    return this._change$.pipe(share());\r\n  }\r\n\r\n  visit(callback: (item: Menu, parentMenum: Menu, depth?: number) => void) {\r\n    const inFn = (list: Menu[], parentMenu: Menu, depth: number) => {\r\n      for (const item of list) {\r\n        callback(item, parentMenu, depth);\r\n        if (item.children && item.children.length > 0) {\r\n          inFn(item.children, item, depth + 1);\r\n        } else {\r\n          item.children = [];\r\n        }\r\n      }\r\n    };\r\n\r\n    inFn(this.data, null, 0);\r\n  }\r\n\r\n  add(items: Menu[]) {\r\n    this.data = items;\r\n    this.resume();\r\n  }\r\n\r\n  /**\r\n   * 重置菜单，可能I18N、用户权限变动时需要调用刷新\r\n   */\r\n  resume(callback?: (item: Menu, parentMenum: Menu, depth?: number) => void) {\r\n    let i = 1;\r\n    const shortcuts: Menu[] = [];\r\n    this.visit((item, parent, depth) => {\r\n      item.__id = i++;\r\n      item.__parent = parent;\r\n      item._depth = depth;\r\n\r\n      if (!item.link) item.link = '';\r\n      if (!item.externalLink) item.externalLink = '';\r\n\r\n      // badge\r\n      if (item.badge) {\r\n        if (item.badge_dot !== true) {\r\n          item.badge_dot = false;\r\n        }\r\n        if (!item.badge_status) {\r\n          item.badge_status = 'error';\r\n        }\r\n      }\r\n\r\n      item._type = item.externalLink ? 2 : 1;\r\n      if (item.children && item.children.length > 0) {\r\n        item._type = 3;\r\n      }\r\n\r\n      // shortcut\r\n      if (parent && item.shortcut === true && parent.shortcut_root !== true)\r\n        shortcuts.push(item);\r\n\r\n      item.text =\r\n        item.i18n && this.i18nSrv ? this.i18nSrv.fanyi(item.i18n) : item.text;\r\n\r\n      // hidden\r\n      item._hidden = typeof item.hide === 'undefined' ? false : item.hide;\r\n\r\n      // acl\r\n      if (item.acl && this.aclService) {\r\n        item._hidden = !this.aclService.can(item.acl);\r\n      }\r\n\r\n      if (callback) callback(item, parent, depth);\r\n    });\r\n\r\n    this.loadShortcut(shortcuts);\r\n    this._change$.next(this.data);\r\n  }\r\n\r\n  /**\r\n   * 加载快捷菜单，加载位置规则如下：\r\n   * 1、统一在下标0的节点下（即【主导航】节点下方）\r\n   *      1、若 children 存在 【shortcut_root: true】则最优先【推荐】这种方式\r\n   *      2、否则查找带有【dashboard】字样链接，若存在则在此菜单的下方创建快捷入口\r\n   *      3、否则放在0节点位置\r\n   */\r\n  private loadShortcut(shortcuts: Menu[]) {\r\n    if (shortcuts.length === 0 || this.data.length === 0) {\r\n      return;\r\n    }\r\n\r\n    const ls = this.data[0].children;\r\n    let pos = ls.findIndex(w => w.shortcut_root === true);\r\n    if (pos === -1) {\r\n      pos = ls.findIndex(w => w.link.includes('dashboard'));\r\n      pos = (pos !== -1 ? pos : -1) + 1;\r\n      const shortcutMenu = <Menu>{\r\n        text: '快捷菜单',\r\n        i18n: 'shortcut',\r\n        icon: 'icon-rocket',\r\n        children: [],\r\n      };\r\n      this.data[0].children.splice(pos, 0, shortcutMenu);\r\n    }\r\n    let _data = this.data[0].children[pos];\r\n    if (_data.i18n && this.i18nSrv) _data.text = this.i18nSrv.fanyi(_data.i18n);\r\n    _data = Object.assign(_data, {\r\n      shortcut_root: true,\r\n      _type: 3,\r\n      __id: -1,\r\n      _depth: 1,\r\n    });\r\n    _data.children = shortcuts.map(i => {\r\n      i._depth = 2;\r\n      return i;\r\n    });\r\n  }\r\n\r\n  get menus() {\r\n    return this.data;\r\n  }\r\n\r\n  /**\r\n   * 清空菜单\r\n   */\r\n  clear() {\r\n    this.data = [];\r\n    this._change$.next(this.data);\r\n  }\r\n\r\n  /**\r\n   * 根据URL设置菜单 `_open` 属性\r\n   * @param url URL地址\r\n   */\r\n  openedByUrl(url: string) {\r\n    if (!url) return;\r\n\r\n    let findItem: Menu = null;\r\n    this.visit(item => {\r\n      item._open = false;\r\n      if (!item.link) {\r\n        return;\r\n      }\r\n      if (!findItem && url.startsWith(item.link)) {\r\n        findItem = item;\r\n      }\r\n    });\r\n    if (!findItem) return;\r\n\r\n    do {\r\n      findItem._open = true;\r\n      findItem = findItem.__parent;\r\n    } while (findItem);\r\n  }\r\n\r\n  /**\r\n   * 根据url获取菜单列表\r\n   * @param url\r\n   */\r\n  getPathByUrl(url: string): Menu[] {\r\n    let item: Menu = null;\r\n    this.visit((i, parent, depth) => {\r\n      if (i.link === url) {\r\n        item = i;\r\n      }\r\n    });\r\n\r\n    const ret: Menu[] = [];\r\n    if (!item) return ret;\r\n\r\n    do {\r\n      ret.splice(0, 0, item);\r\n      item = item.__parent;\r\n    } while (item);\r\n\r\n    return ret;\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this._change$.unsubscribe();\r\n    if (this.i18n$) this.i18n$.unsubscribe();\r\n  }\r\n}\r\n"]}