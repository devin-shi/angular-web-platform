{"version":3,"file":"upload.widget.js","sourceRoot":"","sources":["../../../../../../../packages/form/src/widgets/upload/upload.widget.ts"],"names":[],"mappings":"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","sourcesContent":["import { Component, OnInit, ChangeDetectorRef } from '@angular/core';\r\nimport { deepGet } from '@delon/util';\r\nimport { UploadFile, UploadChangeParam, NzModalService } from 'ng-zorro-antd';\r\nimport { ControlWidget } from '../../widget';\r\nimport { getData } from '../../utils';\r\n\r\n@Component({\r\n  selector: 'sf-upload',\r\n  template: `\r\n  <sf-item-wrap [id]=\"id\" [schema]=\"schema\" [ui]=\"ui\" [showError]=\"showError\" [error]=\"error\" [showTitle]=\"schema.title\">\r\n\r\n    <nz-upload\r\n      [nzType]=\"i.type\"\r\n      [nzFileList]=\"fileList\"\r\n      [nzDisabled]=\"disabled\"\r\n      [nzAction]=\"i.action\"\r\n      [nzAccept]=\"i.accept\"\r\n      [nzLimit]=\"i.limit\"\r\n      [nzSize]=\"i.size\"\r\n      [nzFileType]=\"i.fileType\"\r\n      [nzHeaders]=\"ui.headers\"\r\n      [nzData]=\"ui.data\"\r\n      [nzListType]=\"i.listType\"\r\n      [nzMultiple]=\"i.multiple\"\r\n      [nzName]=\"i.argName\"\r\n      [nzShowUploadList]=\"i.showUploadList\"\r\n      [nzWithCredentials]=\"i.withCredentials\"\r\n      [nzRemove]=\"ui.remove\"\r\n      [nzPreview]=\"handlePreview\"\r\n      (nzChange)=\"change($event)\">\r\n      <ng-container [ngSwitch]=\"btnType\">\r\n        <ng-container *ngSwitchCase=\"'plus'\">\r\n          <i class=\"anticon anticon-plus\"></i>\r\n          <div class=\"ant-upload-text\" [innerHTML]=\"i.text\"></div>\r\n        </ng-container>\r\n        <ng-container *ngSwitchCase=\"'drag'\">\r\n          <p class=\"ant-upload-drag-icon\"><i class=\"anticon anticon-inbox\"></i></p>\r\n          <p class=\"ant-upload-text\" [innerHTML]=\"i.text\"></p>\r\n          <p class=\"ant-upload-hint\" [innerHTML]=\"i.hint\"></p>\r\n        </ng-container>\r\n        <ng-container *ngSwitchDefault>\r\n          <button type=\"button\" nz-button>\r\n            <i class=\"anticon anticon-upload\"></i><span [innerHTML]=\"i.text\"></span>\r\n          </button>\r\n        </ng-container>\r\n      </ng-container>\r\n    </nz-upload>\r\n\r\n  </sf-item-wrap>\r\n  `,\r\n  preserveWhitespaces: false,\r\n})\r\nexport class UploadWidget extends ControlWidget implements OnInit {\r\n  i: any;\r\n  fileList: UploadFile[] = [];\r\n  btnType = '';\r\n\r\n  constructor(cd: ChangeDetectorRef, private modalSrv: NzModalService) {\r\n    super(cd);\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    this.i = {\r\n      type: this.ui.type || 'select',\r\n      text: this.ui.text || '点击上传',\r\n      action: this.ui.action || '',\r\n      accept: this.ui.accept || '',\r\n      limit: this.ui.limit == null ? 0 : +this.ui.limit,\r\n      size: this.ui.size == null ? 0 : +this.ui.size,\r\n      fileType: this.ui.fileType || '',\r\n      listType: this.ui.listType || 'text',\r\n      multiple: this.ui.multiple || false,\r\n      name: this.ui.name || 'file',\r\n      showUploadList: this.ui.showUploadList || true,\r\n      withCredentials: this.ui.withCredentials || false,\r\n      resReName: (this.ui.resReName || '').split('.'),\r\n    };\r\n    if (this.i.listType === 'picture-card') this.btnType = 'plus';\r\n    if (this.i.type === 'drag') {\r\n      this.i.listType = null;\r\n      this.btnType = 'drag';\r\n      this.i.text = this.ui.text || `单击或拖动文件到该区域上传`;\r\n      this.i.hint =\r\n        this.ui.hint || `支持单个或批量，严禁上传公司数据或其他安全文件`;\r\n    }\r\n  }\r\n\r\n  change(args: UploadChangeParam) {\r\n    if (this.ui.change) this.ui.change(args);\r\n    if (args.type !== 'success') return;\r\n    this.notify(args.fileList);\r\n  }\r\n\r\n  reset(value: any) {\r\n    getData(this.schema, this.ui, this.formProperty.formData).subscribe(\r\n      list => {\r\n        this.fileList = list as UploadFile[];\r\n        this.notify(this.fileList);\r\n        this.detectChanges();\r\n      },\r\n    );\r\n  }\r\n\r\n  private notify(fileList: UploadFile[]) {\r\n    const res = fileList.map(item =>\r\n      deepGet(item.response, this.i.resReName, item.response),\r\n    );\r\n    this.formProperty.setValue(\r\n      this.i.multiple === true ? res : res.pop(),\r\n      false,\r\n    );\r\n  }\r\n\r\n  handlePreview = (file: UploadFile) => {\r\n    this.modalSrv\r\n      .create({\r\n        nzContent: `<img src=\"${file.url ||\r\n          file.thumbUrl}\" class=\"img-fluid\" />`,\r\n        nzFooter: null,\r\n      })\r\n      .afterClose.subscribe(() => this.detectChanges());\r\n  };\r\n}\r\n"]}