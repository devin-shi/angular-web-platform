{"version":3,"file":"mention.widget.js","sourceRoot":"","sources":["../../../../../../../packages/form/src/widgets/mention/mention.widget.ts"],"names":[],"mappings":"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","sourcesContent":["import { Component, OnInit, ViewChild } from '@angular/core';\r\nimport { Observable } from 'rxjs/Observable';\r\nimport { tap, map } from 'rxjs/operators';\r\nimport { ControlWidget } from '../../widget';\r\nimport { getData, getEnum } from '../../utils';\r\nimport { SFSchemaEnum, SFSchemaEnumType } from '../../schema';\r\nimport { FormProperty, PropertyGroup } from '../../model/form.property';\r\nimport { NzMentionComponent } from 'ng-zorro-antd';\r\n\r\n@Component({\r\n  selector: 'sf-mention',\r\n  template: `\r\n    <sf-item-wrap [id]=\"id\" [schema]=\"schema\" [ui]=\"ui\" [showError]=\"showError\" [error]=\"error\" [showTitle]=\"schema.title\">\r\n\r\n      <nz-mention #mentions\r\n        [nzSuggestions]=\"data\"\r\n        [nzValueWith]=\"i.valueWith\"\r\n        [nzLoading]=\"loading\"\r\n        [nzNotFoundContent]=\"i.notFoundContent\"\r\n        [nzPlacement]=\"i.placement\"\r\n        [nzPrefix]=\"i.prefix\"\r\n        (nzOnSelect)=\"_select($event)\"\r\n        (nzOnSearchChange)=\"_search($event)\">\r\n\r\n        <ng-container *ngIf=\"ui.inputStyle !== 'textarea'\">\r\n          <input nzMentionTrigger nz-input\r\n            [attr.id]=\"id\"\r\n            [disabled]=\"disabled\"\r\n            [nzSize]=\"ui.size\"\r\n            [ngModel]=\"value\"\r\n            (ngModelChange)=\"setValue($event)\"\r\n            [attr.maxLength]=\"schema.maxLength || null\"\r\n            [attr.placeholder]=\"ui.placeholder\"\r\n            autocomplete=\"off\">\r\n        </ng-container>\r\n\r\n        <ng-container *ngIf=\"ui.inputStyle === 'textarea'\">\r\n          <textarea nzMentionTrigger nz-input\r\n            [attr.id]=\"id\"\r\n            [disabled]=\"disabled\"\r\n            [nzSize]=\"ui.size\"\r\n            [ngModel]=\"value\"\r\n            (ngModelChange)=\"setValue($event)\"\r\n            [attr.maxLength]=\"schema.maxLength || null\"\r\n            [attr.placeholder]=\"ui.placeholder\"\r\n            [nzAutosize]=\"ui.autosize\">\r\n          </textarea>\r\n        </ng-container>\r\n\r\n      </nz-mention>\r\n\r\n    </sf-item-wrap>\r\n    `,\r\n  preserveWhitespaces: false,\r\n})\r\nexport class MentionWidget extends ControlWidget implements OnInit {\r\n  @ViewChild('mentions') mentionChild: NzMentionComponent;\r\n  data: SFSchemaEnum[] = [];\r\n  i: any;\r\n  loading = false;\r\n\r\n  ngOnInit(): void {\r\n    this.i = {\r\n      valueWith: this.ui.valueWith || (item => item.label),\r\n      notFoundContent:\r\n        this.ui.notFoundContent || '无匹配结果，轻敲空格完成输入',\r\n      placement: this.ui.placement || 'bottom',\r\n      prefix: this.ui.prefix || '@',\r\n    };\r\n    const min =\r\n        typeof this.schema.minimum !== 'undefined' ? this.schema.minimum : -1,\r\n      max =\r\n        typeof this.schema.maximum !== 'undefined' ? this.schema.maximum : -1;\r\n    if (!this.ui.validator && (min !== -1 || max !== -1)) {\r\n      this.ui.validator = (\r\n        value: any,\r\n        formProperty: FormProperty,\r\n        form: PropertyGroup,\r\n      ) => {\r\n        const count = this.mentionChild.getMentions().length;\r\n        if (min !== -1 && count < min) {\r\n          return [{ keyword: 'mention', message: `最少提及 ${min} 次` }];\r\n        }\r\n        if (max !== -1 && count > max) {\r\n          return [{ keyword: 'mention', message: `最多提及 ${max} 次` }];\r\n        }\r\n        return null;\r\n      };\r\n    }\r\n  }\r\n\r\n  reset(value: any) {\r\n    getData(this.schema, this.ui, null).subscribe(list => {\r\n      this.data = list;\r\n      this.detectChanges();\r\n    });\r\n  }\r\n\r\n  _select(options: any) {\r\n    if (this.ui.select) this.ui.select(options);\r\n  }\r\n\r\n  _search(option: any) {\r\n    if (typeof this.ui.loadData !== 'function') return;\r\n\r\n    this.loading = true;\r\n    (this.ui.loadData(option) as Observable<SFSchemaEnumType[]>)\r\n      .pipe(tap(() => (this.loading = false)), map(res => getEnum(res, null)))\r\n      .subscribe(res => {\r\n        this.data = res;\r\n        this.cd.detectChanges();\r\n      });\r\n  }\r\n}\r\n"]}